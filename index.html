<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Í±∞Î¶¨ Ï∏°Ï†ï ÌÉÄÏù¥Î®∏ (Í≥†Ï†ïÎ∞Ä GPS)</title>
<style>
  body {
    text-align: center;
    font-family: Arial, sans-serif;
    margin-top: 50px;
    background-color: #f0f0f0;
  }
  #timer {
    font-size: 100px;
    margin: 20px;
  }
  #distance {
    font-size: 50px;
    margin: 10px;
  }
  select, button {
    font-size: 22px;
    padding: 10px 20px;
    margin: 10px;
  }
  button {
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }
  button:disabled { background-color: gray; cursor: default; }
</style>
</head>
<body>

<h1>üèÉ Îã¨Î¶¨Í∏∞ Ï∏°Ï†ïÍ∏∞ (Í≥†Ï†ïÎ∞Ä)</h1>

<div>
  Î™©Ìëú Í±∞Î¶¨(m): 
  <select id="goalDistance">
    <option value="50">50m</option>
    <option value="60">60m</option>
    <option value="70">70m</option>
    <option value="80">80m</option>
    <option value="90">90m</option>
    <option value="100" selected>100m</option>
  </select>
</div>

<div id="timer">00.00</div>
<div id="distance">Îã¨Î¶∞ Í±∞Î¶¨: 0m</div>

<button id="startBtn" onclick="startCountdown()" disabled>ÏãúÏûë</button>
<button id="stopBtn" onclick="stopRun()" disabled>Ï§ëÎã®</button>
<p id="status">GPS Ï§ÄÎπÑ Ï§ë...</p>

<audio id="startSound" src="start.mp3"></audio>

<script>
let startTime;
let timerInterval;
let watchId;
let prevPosition;
let totalDistance = 0;

let gpsReady = false;
let stableStartPositionData = null;

function formatTime(ms) {
  const totalCentis = Math.floor(ms / 10);
  const seconds = Math.floor(totalCentis / 100);
  const centis = totalCentis % 100;
  return (seconds < 10 ? "0" : "") + seconds + "." + (centis < 10 ? "0" : "") + centis;
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// GPS ÏïàÏ†ïÌôî
function getStableStartPosition(callback) {
  let attempts = 0;
  let positions = [];

  const checkPosition = () => {
    navigator.geolocation.getCurrentPosition(function(pos) {
      if (pos.coords.accuracy > 15) {
        setTimeout(checkPosition, 500);
        return;
      }

      positions.push(pos.coords);
      attempts++;

      if (attempts < 5) {
        setTimeout(checkPosition, 500);
      } else {
        let latSum=0, lonSum=0;
        positions.forEach(p => {
          latSum += p.latitude;
          lonSum += p.longitude;
        });

        callback({
          latitude: latSum/positions.length,
          longitude: lonSum/positions.length
        });
      }
    }, null, { enableHighAccuracy: true });
  };

  checkPosition();
}

window.onload = function() {
  getStableStartPosition(function(stablePos) {
    stableStartPositionData = stablePos;
    gpsReady = true;
    document.getElementById("status").innerText = "Ï§ÄÎπÑ ÏôÑÎ£å";
    document.getElementById("startBtn").disabled = false;
  });
};

function startCountdown() {
  if (!gpsReady) return;

  prevPosition = stableStartPositionData;
  totalDistance = 0;

  document.getElementById("distance").innerText = "Îã¨Î¶∞ Í±∞Î¶¨: 0m";
  document.getElementById("startBtn").disabled = true;

  let count = 3;
  document.getElementById("timer").innerText = count;

  let countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      document.getElementById("timer").innerText = count;
    } else {
      clearInterval(countdownInterval);
      document.getElementById("startSound").play();
      startTimer();
      startGPSWatch();
      document.getElementById("status").innerText = "Ï∏°Ï†ï Ï§ë...";
      document.getElementById("stopBtn").disabled = false;
    }
  }, 1000);
}

function startTimer() {
  startTime = Date.now();
  timerInterval = setInterval(() => {
    let elapsed = Date.now() - startTime;
    document.getElementById("timer").innerText = formatTime(elapsed);
  }, 10);
}

// üî• Í≥†Ï†ïÎ∞Ä GPS Ï∂îÏ†Å
function startGPSWatch() {
  const goalDistance = parseFloat(document.getElementById("goalDistance").value);

  let positionHistory = [];
  const MAX_JUMP = 3;     
  const MAX_SPEED = 12;   

  watchId = navigator.geolocation.watchPosition(function(position) {

    if (position.coords.accuracy > 10) return;

    const newPos = {
      latitude: position.coords.latitude,
      longitude: position.coords.longitude,
      timestamp: position.timestamp
    };

    positionHistory.push(newPos);
    if (positionHistory.length > 5) positionHistory.shift();

    let avgLat = 0;
    let avgLon = 0;

    positionHistory.forEach(p => {
      avgLat += p.latitude;
      avgLon += p.longitude;
    });

    avgLat /= positionHistory.length;
    avgLon /= positionHistory.length;

    let distance = getDistance(
      prevPosition.latitude,
      prevPosition.longitude,
      avgLat,
      avgLon
    );

    let timeDiff = (newPos.timestamp - startTime) / 1000;
    let speed = distance / (timeDiff || 1);

    if (distance > MAX_JUMP) return;
    if (speed > MAX_SPEED) return;
    if (distance < 0.5) distance = 0;

    totalDistance += distance;
    if (totalDistance > goalDistance) totalDistance = goalDistance;

    prevPosition = {
      latitude: avgLat,
      longitude: avgLon
    };

    document.getElementById("distance").innerText =
      "Îã¨Î¶∞ Í±∞Î¶¨: " + Math.floor(totalDistance) + "m";

    if (totalDistance >= goalDistance) stopRun();

  }, null, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 5000
  });
}

function stopRun() {
  clearInterval(timerInterval);
  if (watchId) navigator.geolocation.clearWatch(watchId);

  document.getElementById("status").innerText = "Ï∏°Ï†ï Ï¢ÖÎ£å";
  document.getElementById("stopBtn").disabled = true;
  document.getElementById("startBtn").disabled = false;
}
</script>

</body>
</html>
