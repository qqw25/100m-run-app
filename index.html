<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>ê±°ë¦¬ ì¸¡ì • íƒ€ì´ë¨¸ (GPS + ì‚¬ìš´ë“œ)</title>
<style>
  body {
    text-align: center;
    font-family: Arial, sans-serif;
    margin-top: 50px;
    background-color: #f0f0f0;
  }
  #timer {
    font-size: 100px;
    color: red;
    margin: 20px;
  }
  #distance {
    font-size: 50px;
    color: blue;
    margin: 10px;
  }
  select, button {
    font-size: 22px;
    padding: 10px 20px;
    margin: 10px;
  }
  button {
    border-radius: 10px;
    border: none;
    cursor: pointer;
    color: white;
  }
  #startBtn { background-color: green; }
  #stopBtn { background-color: orange; }
  button:disabled { background-color: gray; cursor: default; }
</style>
</head>
<body>

<h1>ğŸƒ ë‹¬ë¦¬ê¸° ì¸¡ì •ê¸°</h1>

<div>
  ëª©í‘œ ê±°ë¦¬(m): 
  <select id="goalDistance">
    <option value="50">50m</option>
    <option value="60">60m</option>
    <option value="70">70m</option>
    <option value="80">80m</option>
    <option value="90">90m</option>
    <option value="100" selected>100m</option>
  </select>
</div>

<div id="timer">00.00</div>
<div id="distance">ë‹¬ë¦° ê±°ë¦¬: 0m</div>

<button id="startBtn" onclick="startCountdown()">ì‹œì‘</button>
<button id="stopBtn" onclick="stopRun()" disabled>ì¤‘ê°„ ë©ˆì¶¤</button>
<p id="status"></p>

<!-- ì‹œì‘/ì¢…ë£Œ ì‚¬ìš´ë“œ -->
<audio id="startSound" src="start.mp3"></audio>
<audio id="finishSound" src="finish.mp3"></audio>

<script>
let startTime;
let timerInterval;
let watchId;
let startPosition;
let prevPosition;
let totalDistance = 0;

function formatTime(ms) {
  const totalCentis = Math.floor(ms / 10);
  const seconds = Math.floor(totalCentis / 100);
  const centis = totalCentis % 100;
  return (seconds < 10 ? "0" : "") + seconds + "." + (centis < 10 ? "0" : "") + centis;
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// GPS ì´ˆê¸° ìœ„ì¹˜ ì•ˆì •í™”
function getStableStartPosition(callback) {
  let attempts = 0;
  let positions = [];
  const checkPosition = () => {
    navigator.geolocation.getCurrentPosition(function(pos) {
      if (pos.coords.accuracy > 15) { setTimeout(checkPosition, 500); return; }
      positions.push(pos.coords);
      attempts++;
      if (attempts < 5) { setTimeout(checkPosition, 500); }
      else {
        let latSum=0, lonSum=0;
        positions.forEach(p => { latSum += p.latitude; lonSum += p.longitude; });
        callback({ latitude: latSum/positions.length, longitude: lonSum/positions.length });
      }
    }, function(error) { alert("ìœ„ì¹˜ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); }, { enableHighAccuracy: true });
  };
  checkPosition();
}

function startCountdown() {
  document.getElementById("status").innerText = "GPS ì•ˆì •í™” ì¤‘...";
  document.getElementById("startBtn").disabled = true;

  getStableStartPosition(function(stablePos) {
    startPosition = stablePos;
    prevPosition = stablePos;
    totalDistance = 0;
    document.getElementById("distance").innerText = "ë‹¬ë¦° ê±°ë¦¬: 0m";
    document.getElementById("status").innerText = "ì¸¡ì • ì¤€ë¹„ ì™„ë£Œ";

    let count = 3;
    document.getElementById("timer").innerText = count;
    let countdownInterval = setInterval(() => {
      count--;
      if (count > 0) document.getElementById("timer").innerText = count;
      else {
        clearInterval(countdownInterval);
        // ì‹œì‘ìŒ ì¬ìƒ
        document.getElementById("startSound").play();
        startTimer();
        startGPSWatch();
        document.getElementById("status").innerText = "ì¸¡ì • ì¤‘...";
        document.getElementById("stopBtn").disabled = false;
      }
    }, 1000);
  });
}

function startTimer() {
  startTime = Date.now();
  timerInterval = setInterval(() => {
    let elapsed = Date.now() - startTime;
    document.getElementById("timer").innerText = formatTime(elapsed);
  }, 10);
}

function startGPSWatch() {
  if (!navigator.geolocation) { alert("GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤."); return; }
  const goalDistance = parseFloat(document.getElementById("goalDistance").value);
  watchId = navigator.geolocation.watchPosition(function(position) {
    if (position.coords.accuracy > 15) return; // ì •í™•ë„ ë‚®ìœ¼ë©´ ë¬´ì‹œ

    let distance = getDistance(
      prevPosition.latitude,
      prevPosition.longitude,
      position.coords.latitude,
      position.coords.longitude
    );

    if (distance < 1) distance = 0; // íŠ€ê¹€ ë°©ì§€
    totalDistance += distance;
    if (totalDistance > goalDistance) totalDistance = goalDistance;

    prevPosition = position.coords;
    document.getElementById("distance").innerText = "ë‹¬ë¦° ê±°ë¦¬: " + Math.floor(totalDistance) + "m";

    if (totalDistance >= goalDistance) stopRun();
  }, function(error) { console.log("GPS ê°ì‹œ ì˜¤ë¥˜:", error); }, { enableHighAccuracy: true });
}

function stopRun() {
  clearInterval(timerInterval);
  if (watchId) navigator.geolocation.clearWatch(watchId);
  document.getElementById("status").innerText = "ì¸¡ì • ì¢…ë£Œ";
  // ì¢…ë£ŒìŒ ì¬ìƒ
  document.getElementById("finishSound").play();
  document.getElementById("startBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
}
</script>

</body>
</html>
