<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>ê±°ë¦¬ ì¸¡ì • íƒ€ì´ë¨¸</title>
<style>
  body {
    text-align: center;
    font-family: Arial, sans-serif;
    margin-top: 50px;
  }
  #timer {
    font-size: 60px;
    margin: 20px;
  }
  #distance {
    font-size: 30px;
    margin: 10px;
  }
  input, button {
    font-size: 18px;
    padding: 5px 10px;
    margin: 5px;
  }
</style>
</head>
<body>

<h1>ğŸƒ ë‹¬ë¦¬ê¸° ì¸¡ì •ê¸°</h1>

<div>
  ëª©í‘œ ê±°ë¦¬(m): <input type="number" id="goalDistance" value="100" />
  ë‹¨ìœ„(m): <input type="number" id="unitDistance" value="10" />
</div>

<div id="timer">00.00</div>
<div id="distance">ê±°ë¦¬: 0m</div>
<button id="startBtn" onclick="startCountdown()">ì‹œì‘</button>
<button id="stopBtn" onclick="stopRun()" disabled>ì¤‘ê°„ ë©ˆì¶¤</button>
<p id="status"></p>

<script>
let startTime;
let timerInterval;
let watchId;
let startPosition;
let totalDistance = 0;

function formatTime(ms) {
  const totalCentis = Math.floor(ms / 10);
  const seconds = Math.floor(totalCentis / 100);
  const centis = totalCentis % 100;
  const secStr = seconds < 10 ? "0" + seconds : seconds;
  const centiStr = centis < 10 ? "0" + centis : centis;
  return secStr + "." + centiStr;
}

function startCountdown() {
  document.getElementById("status").innerText = "ì¸¡ì • ì¤€ë¹„ ì¤‘...";
  document.getElementById("startBtn").disabled = true;

  let count = 3;
  document.getElementById("timer").innerText = count;

  let countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      document.getElementById("timer").innerText = count;
    } else {
      clearInterval(countdownInterval);
      startTimer();
      startGPSWatch();
      document.getElementById("status").innerText = "ì¸¡ì • ì¤‘...";
      document.getElementById("stopBtn").disabled = false;
    }
  }, 1000);
}

function startTimer() {
  startTime = Date.now();
  timerInterval = setInterval(() => {
    let elapsed = Date.now() - startTime;
    document.getElementById("timer").innerText = formatTime(elapsed);
  }, 10);
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function startGPSWatch() {
  if (!navigator.geolocation) {
    alert("GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.");
    return;
  }

  navigator.geolocation.getCurrentPosition(function(position) {
    startPosition = position.coords;
    totalDistance = 0;
  }, function(error) {
    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }, { enableHighAccuracy: true });

  const goalDistance = parseFloat(document.getElementById("goalDistance").value);
  const unitDistance = parseFloat(document.getElementById("unitDistance").value);

  watchId = navigator.geolocation.watchPosition(function(position) {
    let distance = getDistance(
      startPosition.latitude,
      startPosition.longitude,
      position.coords.latitude,
      position.coords.longitude
    );

    // ë‹¨ìœ„ ë‹¨ìœ„ë¡œ ê±°ë¦¬ í‘œì‹œ
    let unitsReached = Math.floor(distance / unitDistance) * unitDistance;
    document.getElementById("distance").innerText = "ê±°ë¦¬: " + unitsReached + "m";

    if (distance >= goalDistance) {
      stopRun();
    }
  }, function(error) {
    console.log("ìœ„ì¹˜ ì •ë³´ ê°ì‹œ ì˜¤ë¥˜:", error);
  }, { enableHighAccuracy: true });
}

function stopRun() {
  clearInterval(timerInterval);
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
  }
  document.getElementById("status").innerText = "ì¸¡ì • ì¢…ë£Œ";
  document.getElementById("startBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
}
</script>

</body>
</html>
