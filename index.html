<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>100m ë‹¬ë¦¬ê¸° ì¸¡ì •ê¸°</title>
<style>
  body {
    text-align: center;
    font-family: Arial, sans-serif;
    margin-top: 100px;
  }
  #timer {
    font-size: 60px;
    margin: 20px;
  }
  button {
    font-size: 20px;
    padding: 10px 20px;
  }
</style>
</head>
<body>

<h1>ğŸƒ 100m ë‹¬ë¦¬ê¸°</h1>
<div id="timer">00.00</div>
<button onclick="startCountdown()" id="startBtn">ì‹œì‘</button>
<p id="status"></p>

<script>
let startTime;
let timerInterval;
let watchId;
let startPosition;

function formatTime(ms) {
  // ms(ë°€ë¦¬ì´ˆ)ë¥¼ 100ë¶„ì˜ 1ì´ˆ ë‹¨ìœ„ë¡œ ë°”ê¿”ì„œ
  // 01.00, 02.00, ... í˜•ì‹ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
  const totalCentis = Math.floor(ms / 10); // 1ì„¼í‹°ì´ˆ = 10ms
  const seconds = Math.floor(totalCentis / 100);
  const centis = totalCentis % 100;
  // secondsë¥¼ 2ìë¦¬ ìˆ«ì ë¬¸ìì—´ë¡œ ë§ì¶”ê³  centisë„ 2ìë¦¬ ìœ ì§€
  const secStr = seconds < 10 ? "0" + seconds : seconds;
  const centiStr = centis < 10 ? "0" + centis : centis;
  return secStr + "." + centiStr;
}

function startCountdown() {
  document.getElementById("status").innerText = "ì¸¡ì • ì¤€ë¹„ ì¤‘...";
  document.getElementById("startBtn").disabled = true;

  let count = 3;
  document.getElementById("timer").innerText = count;

  let countdownInterval = setInterval(() => {
    count--;
    if (count > 0) {
      document.getElementById("timer").innerText = count;
    } else {
      clearInterval(countdownInterval);
      startTimer();
      startGPSWatch();
      document.getElementById("status").innerText = "ì¸¡ì • ì¤‘...";
    }
  }, 1000);
}

function startTimer() {
  startTime = Date.now();
  timerInterval = setInterval(() => {
    let elapsed = Date.now() - startTime;
    document.getElementById("timer").innerText = formatTime(elapsed);
  }, 10);
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000; // ì§€êµ¬ ë°˜ê²½(m)
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function startGPSWatch() {
  if (!navigator.geolocation) {
    alert("GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.");
    return;
  }

  navigator.geolocation.getCurrentPosition(function(position) {
    startPosition = position.coords;
  }, function(error) {
    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }, { enableHighAccuracy: true });

  watchId = navigator.geolocation.watchPosition(function(position) {
    let distance = getDistance(
      startPosition.latitude,
      startPosition.longitude,
      position.coords.latitude,
      position.coords.longitude
    );

    if (distance >= 100) {
      stopRun();
    }
  }, function(error) {
    console.log("ìœ„ì¹˜ ì •ë³´ ê°ì‹œ ì˜¤ë¥˜:", error);
  }, { enableHighAccuracy: true });
}

function stopRun() {
  clearInterval(timerInterval);
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
  }
  document.getElementById("status").innerText = "ì™„ë£Œ! 100m ë‹¬ì„±";
  document.getElementById("startBtn").disabled = false;
}
</script>

</body>
</html>
